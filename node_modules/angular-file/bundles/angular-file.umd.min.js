!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@angular/common")):"function"==typeof define&&define.amd?define("angular-file",["exports","@angular/core","@angular/common"],e):e((t=t||self)["angular-file"]={},t.ng.core,t.ng.common)}(this,(function(t,e,i){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};function r(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}function o(t,e,i,n){var r,o=arguments.length,a=o<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,n);else for(var s=t.length-1;s>=0;s--)(r=t[s])&&(a=(o<3?r(a):o>3?r(e,i,a):r(e,i))||a);return o>3&&a&&Object.defineProperty(e,i,a),a}var a=function(t){var e=t.getAttribute("type");return"input"===t.tagName.toLowerCase()&&e&&"file"===e.toLowerCase()},s=0,l=0,f=function(){var t=document.createElement("input");return t.type="file",t};function u(t,e){return h(t,!0).then((function(i){var n=document.createElement("canvas"),r=document.createElement("img");return new Promise((function(o,a){r.onload=function(){try{n.width=e.orientation>4?r.height:r.width,n.height=e.orientation>4?r.width:r.height;var i=n.getContext("2d");!function(t,e,i,n){switch(e){case 2:return t.transform(-1,0,0,1,i,0);case 3:return t.transform(-1,0,0,-1,i,n);case 4:return t.transform(1,0,0,-1,0,n);case 5:return t.transform(0,1,1,0,0,0);case 6:return t.transform(0,1,-1,0,n,0);case 7:return t.transform(0,-1,-1,0,n,i);case 8:t.transform(0,-1,1,0,0,i)}}(i,e.orientation,r.width,r.height),i.drawImage(r,0,0);var s=n.toDataURL(t.type||"image/WebP",.934),l=function(t){for(var e="",i=new Uint8Array(t),n=i.byteLength,r=0;r<n;r++)e+=String.fromCharCode(i[r]);return window.btoa(e)}(e.fixedArrayBuffer),f=function(t,e,i){for(var n=t.split(","),r=n[0].match(/:(.*?);/),o=r?r[1]:"text/plain",a=atob(n[1]),s=a.length,l=new Uint8Array(s);s--;)l[s]=a.charCodeAt(s);var f=new window.Blob([l],{type:o});return f.name=e,f.$ngfOrigSize=i,f}(s={KEY_STR:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode64:function(t){var e,i,n,r,o,a="",s="",l="",f=0;do{n=(e=t[f++])>>2,r=(3&e)<<4|(i=t[f++])>>4,o=(15&i)<<2|(s=t[f++])>>6,l=63&s,isNaN(i)?o=l=64:isNaN(s)&&(l=64),a=a+this.KEY_STR.charAt(n)+this.KEY_STR.charAt(r)+this.KEY_STR.charAt(o)+this.KEY_STR.charAt(l),e=i=s="",n=r=o=l=""}while(f<t.length);return a},restore:function(t,e){t.match("data:image/jpeg;base64,")&&(t=t.replace("data:image/jpeg;base64,",""));var i=this.decode64(t),n=this.slice2Segments(i),r=this.exifManipulation(e,n);return"data:image/jpeg;base64,"+this.encode64(r)},exifManipulation:function(t,e){var i=this.getExifArray(e),n=this.insertExif(t,i);return new Uint8Array(n)},getExifArray:function(t){for(var e,i=0;i<t.length;i++)if(255===(e=t[i])[0]&&225===e[1])return e;return[]},insertExif:function(t,e){var i=t.replace("data:image/jpeg;base64,",""),n=this.decode64(i),r=n.indexOf(255,3),o=n.slice(0,r),a=n.slice(r),s=o;return s=(s=s.concat(e)).concat(a)},slice2Segments:function(t){for(var e=0,i=[];255!==t[e]||218!==t[e+1];){if(255===t[e]&&216===t[e+1])e+=2;else{var n=e+(256*t[e+2]+t[e+3])+2,r=t.slice(e,n);i.push(r),e=n}if(e>t.length)break}return i},decode64:function(t){var e,i,n,r,o="",a="",s=0,l=[];/[^A-Za-z0-9\+\/\=]/g.exec(t)&&console.log("There were invalid base64 characters in the input text."),t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");do{e=this.KEY_STR.indexOf(t.charAt(s++))<<2|(n=this.KEY_STR.indexOf(t.charAt(s++)))>>4,i=(15&n)<<4|(r=this.KEY_STR.indexOf(t.charAt(s++)))>>2,o=(3&r)<<6|(a=this.KEY_STR.indexOf(t.charAt(s++))),l.push(e),64!==r&&l.push(i),64!==a&&l.push(o),e=i=o="",n=r=a=""}while(s<t.length);return l}}.restore(l,s),t.name);o(f)}catch(t){a(t)}},r.onerror=a,r.src=i}))}))}function p(t){return 0!==t.type.indexOf("image/jpeg")?Promise.resolve(t):function(t){return new Promise((function(e,i){var n=new FileReader,r=t.slice?t.slice(0,65536):t;n.readAsArrayBuffer(r),n.onerror=i,n.onload=function(t){var i={orientation:1},n=new DataView(this.result);if(65496!==n.getUint16(0,!1))return e(i);for(var r=n.byteLength,o=2;o<r;){var a=n.getUint16(o,!1);if(o+=2,65505===a){if(1165519206!==n.getUint32(o+=2,!1))return e(i);var s=18761===n.getUint16(o+=6,!1);o+=n.getUint32(o+4,s);var l=n.getUint16(o,s);o+=2;for(var f=0;f<l;f++)if(274===n.getUint16(o+12*f,s)){var u=n.getUint16(o+12*f+8,s);return u>=2&&u<=8&&(n.setUint16(o+12*f+8,1,s),i.fixedArrayBuffer=t.target.result),i.orientation=u,e(i)}}else{if(65280!=(65280&a))break;o+=n.getUint16(o,!1)}}return e(i)}}))}(t).then((function(e){return e.orientation<2||e.orientation>8?t:u(t,e)})).then((function(){return t}))}function h(t,e){if(!t)return Promise.resolve(t);if(e&&null!=t.$ngfDataUrl||!e&&null!=t.$ngfBlobUrl)return Promise.resolve(e?t.$ngfDataUrl:t.$ngfBlobUrl);var i=e?t.$$ngfDataUrlPromise:t.$$ngfBlobUrlPromise;if(i)return i;var n,r=window;if(!r.FileReader||!t||r.FileAPI&&-1!==navigator.userAgent.indexOf("MSIE 8")&&!(t.size<2e4)||r.FileAPI&&-1!==navigator.userAgent.indexOf("MSIE 9")&&!(t.size<4e6))return t[e?"$ngfDataUrl":"$ngfBlobUrl"]="",Promise.reject(new Error("Browser does not support window.FileReader, window.FileReader, or window.FileAPI"));var o=r.URL||r.webkitURL;if(FileReader)n=new Promise((function(e,i){var n=new FileReader;n.onload=function(i){t.$ngfDataUrl=i.target.result,delete t.$ngfDataUrl,e(i.target.result)},n.onerror=function(e){t.$ngfDataUrl="",i(e)},n.readAsDataURL(t)}));else{var a;try{a=o.createObjectURL(t)}catch(t){return Promise.reject(t)}n=Promise.resolve(a),t.$ngfBlobUrl=a}return i=(i=e?t.$$ngfDataUrlPromise=n:t.$$ngfBlobUrlPromise=n).then((function(i){return delete t[e?"$$ngfDataUrlPromise":"$$ngfBlobUrlPromise"],i}))}var c=function(){function t(t){this.element=t,this.filters=[],this.lastFileCount=0,this.ngfFixOrientation=!0,this.fileDropDisabled=!1,this.selectable=!1,this.directiveInit=new e.EventEmitter,this.lastInvalids=[],this.lastInvalidsChange=new e.EventEmitter,this.lastBaseUrlChange=new e.EventEmitter,this.fileChange=new e.EventEmitter,this.files=[],this.filesChange=new e.EventEmitter,this.initFilters()}return t.prototype.initFilters=function(){this.filters.push({name:"accept",fn:this._acceptFilter}),this.filters.push({name:"fileSize",fn:this._fileSizeFilter})},t.prototype.ngOnDestroy=function(){delete this.fileElm},t.prototype.ngOnInit=function(){var t=this;this.selectable&&this.enableSelecting(),this.multiple&&this.paramFileElm().setAttribute("multiple",this.multiple),setTimeout((function(){t.directiveInit.emit(t)}),0)},t.prototype.ngOnChanges=function(t){t.accept&&this.paramFileElm().setAttribute("accept",t.accept.currentValue||"*")},t.prototype.paramFileElm=function(){if(this.fileElm)return this.fileElm;if(a(this.element.nativeElement))return this.fileElm=this.element.nativeElement;var t=function(){var t=f(),e=document.createElement("label");return e.innerHTML="upload",e.style.visibility="hidden",e.style.position="absolute",e.style.overflow="hidden",e.style.width="0px",e.style.height="0px",e.style.border="none",e.style.margin="0px",e.style.padding="0px",e.setAttribute("tabindex","-1"),e.appendChild(t),e}();return this.fileElm=t.getElementsByTagName("input")[0],this.fileElm.addEventListener("change",this.changeFn.bind(this)),this.element.nativeElement.appendChild(t),this.fileElm},t.prototype.enableSelecting=function(){var t=this,e=this.element.nativeElement;if(a(e)){var i=function(e){return t.beforeSelect()};return e.addEventListener("click",i),void e.addEventListener("touchstart",i)}var n=function(e){return t.clickHandler(e)};e.addEventListener("click",n),e.addEventListener("touchstart",n),e.addEventListener("touchend",n)},t.prototype.getValidFiles=function(t){for(var e=[],i=t.length-1;i>=0;--i)this.isFileValid(t[i])&&e.push(t[i]);return e},t.prototype.getInvalidFiles=function(t){for(var e=[],i=t.length-1;i>=0;--i){var n=this.getFileFilterFailName(t[i]);n&&e.push({file:t[i],type:n})}return e},t.prototype.handleFiles=function(t){var e=this,i=this.getValidFiles(t);t.length!=i.length?this.lastInvalids=this.getInvalidFiles(t):delete this.lastInvalids,this.lastInvalidsChange.emit(this.lastInvalids),i.length&&(this.ngfFixOrientation?this.applyExifRotations(i).then((function(t){return e.que(t)})):this.que(i)),this.isEmptyAfterSelection()&&(this.element.nativeElement.value="")},t.prototype.que=function(t){var e=this;this.files=this.files||[],Array.prototype.push.apply(this.files,t),this.filesChange.emit(this.files),t.length&&(this.fileChange.emit(this.file=t[0]),this.lastBaseUrlChange.observers.length&&h(t[0]).then((function(t){return e.lastBaseUrlChange.emit(t)}))),this.lastFileCount=this.files.length},t.prototype.changeFn=function(t){var e=t.__files_||t.target&&t.target.files;e&&(this.stopEvent(t),this.handleFiles(e))},t.prototype.clickHandler=function(t){if(this.element.nativeElement.getAttribute("disabled")||this.fileDropDisabled)return!1;var e=function(t){var e=t.changedTouches||t.originalEvent&&t.originalEvent.changedTouches;if(e){if("touchstart"===t.type)return l=e[0].clientX,s=e[0].clientY,!0;if("touchend"===t.type){var i=e[0].clientX,n=e[0].clientY;if(Math.abs(i-l)>20||Math.abs(n-s)>20)return t.stopPropagation(),t.preventDefault(),!1}return!0}return!1}(t);return!1!==e?e:(this.paramFileElm().click(),this.beforeSelect(),!1)},t.prototype.beforeSelect=function(){this.files&&this.lastFileCount===this.files.length||(this.fileElm.value=null)},t.prototype.isEmptyAfterSelection=function(){return!!this.element.nativeElement.attributes.multiple},t.prototype.eventToTransfer=function(t){return t.dataTransfer?t.dataTransfer:t.originalEvent?t.originalEvent.dataTransfer:null},t.prototype.stopEvent=function(t){t.preventDefault(),t.stopPropagation()},t.prototype.transferHasFiles=function(t){return!!t.types&&(t.types.indexOf?-1!==t.types.indexOf("Files"):!!t.types.contains&&t.types.contains("Files"))},t.prototype.eventToFiles=function(t){var e=this.eventToTransfer(t);if(e){if(e.files&&e.files.length)return e.files;if(e.items&&e.items.length)return e.items}return[]},t.prototype.applyExifRotations=function(t){for(var e=function(e,i){return p(e).then((function(e){return t.splice(i,1,e)}))},i=[],n=t.length-1;n>=0;--n)i[n]=e(t[n],n);return Promise.all(i).then((function(){return t}))},t.prototype.onChange=function(t){var e=this.element.nativeElement.files||this.eventToFiles(t);e.length&&(this.stopEvent(t),this.handleFiles(e))},t.prototype.getFileFilterFailName=function(t){for(var e=0;e<this.filters.length;e++)if(!this.filters[e].fn.call(this,t))return this.filters[e].name},t.prototype.isFileValid=function(t){return!(this.accept||this.filters&&this.filters.length)||!this.getFileFilterFailName(t)},t.prototype.isFilesValid=function(t){for(var e=t.length-1;e>=0;--e)if(!this.isFileValid(t[e]))return!1;return!0},t.prototype._acceptFilter=function(t){return function(t,e,i){if(!t)return!0;for(var n,r,o=t.split(","),a=o.length-1;a>=0;--a){if(r=(r=(r=o[a]).replace(/(^\s+|\s+$)/g,"")).replace(/\*/g,".*"),n=new RegExp(r,"gi"),e.search(n)>=0)return!0;if("."==r.substring(0,1)&&(r="\\"+r,n=new RegExp(r+"$","i"),(i||e).search(n)>=0))return!0}return!1}(this.accept,t.type,t.name)},t.prototype._fileSizeFilter=function(t){return!(this.maxSize&&t.size>this.maxSize)},t.prototype.filesToWriteableObject=function(t){for(var e=[],i=0;i<t.length;++i)e.push({type:t[i].type,kind:t[i].kind});return e},t.ctorParameters=function(){return[{type:e.ElementRef}]},o([e.Input()],t.prototype,"multiple",void 0),o([e.Input()],t.prototype,"accept",void 0),o([e.Input()],t.prototype,"maxSize",void 0),o([e.Input()],t.prototype,"ngfFixOrientation",void 0),o([e.Input()],t.prototype,"fileDropDisabled",void 0),o([e.Input()],t.prototype,"selectable",void 0),o([e.Output("init")],t.prototype,"directiveInit",void 0),o([e.Input()],t.prototype,"lastInvalids",void 0),o([e.Output()],t.prototype,"lastInvalidsChange",void 0),o([e.Input()],t.prototype,"lastBaseUrl",void 0),o([e.Output()],t.prototype,"lastBaseUrlChange",void 0),o([e.Input()],t.prototype,"file",void 0),o([e.Output()],t.prototype,"fileChange",void 0),o([e.Input()],t.prototype,"files",void 0),o([e.Output()],t.prototype,"filesChange",void 0),o([e.HostListener("change",["$event"])],t.prototype,"onChange",null),t=o([e.Directive({selector:"[ngf]",exportAs:"ngf"})],t)}(),g=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e.selectable=!0,e}return r(i,t),o([e.Input()],i.prototype,"selectable",void 0),i=o([e.Directive({selector:"[ngfSelect]",exportAs:"ngfSelect"})],i)}(c),d=function(t){function i(){var i=null!==t&&t.apply(this,arguments)||this;return i.fileOver=new e.EventEmitter,i.validDrag=!1,i.validDragChange=new e.EventEmitter,i.invalidDrag=!1,i.invalidDragChange=new e.EventEmitter,i.dragFilesChange=new e.EventEmitter,i}return r(i,t),i.prototype.onDrop=function(t){if(this.fileDropDisabled)this.stopEvent(t);else{this.closeDrags();var e=this.eventToFiles(t);e.length&&(this.stopEvent(t),this.handleFiles(e))}},i.prototype.handleFiles=function(e){this.fileOver.emit(!1),t.prototype.handleFiles.call(this,e)},i.prototype.onDragOver=function(t){if(this.fileDropDisabled)this.stopEvent(t);else{var e=this.eventToTransfer(t),i=this.eventToFiles(t),n=this.filesToWriteableObject(i);this.dragFilesChange.emit(this.dragFiles=n),i.length?this.validDrag=this.isFilesValid(i):this.validDrag=!0,this.validDragChange.emit(this.validDrag),this.invalidDrag=!this.validDrag,this.invalidDragChange.emit(this.invalidDrag),e.dropEffect="copy",this.stopEvent(t),this.fileOver.emit(!0)}},i.prototype.closeDrags=function(){delete this.validDrag,this.validDragChange.emit(this.validDrag),this.invalidDrag=!1,this.invalidDragChange.emit(this.invalidDrag),delete this.dragFiles,this.dragFilesChange.emit(this.dragFiles)},i.prototype.onDragLeave=function(t){this.fileDropDisabled?this.stopEvent(t):(this.closeDrags(),this.element&&t.currentTarget===this.element[0]||(this.stopEvent(t),this.fileOver.emit(!1)))},o([e.Output()],i.prototype,"fileOver",void 0),o([e.Input()],i.prototype,"validDrag",void 0),o([e.Output()],i.prototype,"validDragChange",void 0),o([e.Input()],i.prototype,"invalidDrag",void 0),o([e.Output()],i.prototype,"invalidDragChange",void 0),o([e.Input()],i.prototype,"dragFiles",void 0),o([e.Output()],i.prototype,"dragFilesChange",void 0),o([e.HostListener("drop",["$event"])],i.prototype,"onDrop",null),o([e.HostListener("dragover",["$event"])],i.prototype,"onDragOver",null),o([e.HostListener("dragleave",["$event"])],i.prototype,"onDragLeave",null),i=o([e.Directive({selector:"[ngfDrop]",exportAs:"ngfDrop"})],i)}(c),v=function(){function t(t){this.ElementRef=t}return t.prototype.ngOnChanges=function(t){var e=this;h(this.file).then((function(t){var i="url('"+(t||"")+"')";e.ElementRef.nativeElement.style.backgroundImage=i}))},t.ctorParameters=function(){return[{type:e.ElementRef}]},o([e.Input("ngfBackground")],t.prototype,"file",void 0),t=o([e.Directive({selector:"[ngfBackground]"})],t)}(),m=function(){function t(){this.percent=0,this.percentChange=new e.EventEmitter}return t.prototype.ngOnChanges=function(t){var e=this;if(t.httpEvent&&t.httpEvent.currentValue){var i=t.httpEvent.currentValue;i.loaded&&i.total&&setTimeout((function(){e.percent=Math.round(100*i.loaded/i.total),e.percentChange.emit(e.percent)}),0)}},o([e.Input()],t.prototype,"percent",void 0),o([e.Output()],t.prototype,"percentChange",void 0),o([e.Input()],t.prototype,"httpEvent",void 0),t=o([e.Directive({selector:"ngfUploadStatus"})],t)}(),y=function(){function t(t){this.postName="file",this.FormData=new FormData,this.FormDataChange=new e.EventEmitter,this.differ=t.find([]).create()}return t.prototype.ngDoCheck=function(){var t=this;this.differ.diff(this.files)&&setTimeout((function(){return t.buildFormData()}),0)},t.prototype.buildFormData=function(){var t=this;"object"==typeof this.files&&this.files.constructor===Array?(this.FormData=new FormData,(this.files||[]).forEach((function(e){return t.FormData.append(t.postName,e,t.fileName||e.name)})),this.FormDataChange.emit(this.FormData)):delete this.FormData},t.ctorParameters=function(){return[{type:e.IterableDiffers}]},o([e.Input()],t.prototype,"files",void 0),o([e.Input()],t.prototype,"postName",void 0),o([e.Input()],t.prototype,"fileName",void 0),o([e.Input()],t.prototype,"FormData",void 0),o([e.Output()],t.prototype,"FormDataChange",void 0),t=o([e.Directive({selector:"ngfFormData"})],t)}(),E=function(){function t(t){this.ElementRef=t}return t.prototype.ngOnChanges=function(t){var e=this;h(this.file).then((function(t){return e.ElementRef.nativeElement.src=t}))},t.ctorParameters=function(){return[{type:e.ElementRef}]},o([e.Input("ngfSrc")],t.prototype,"file",void 0),t=o([e.Directive({selector:"[ngfSrc]"})],t)}(),D=[d,g,v,E,m,y,c],F=function(){function t(){}return t=o([e.NgModule({imports:[i.CommonModule],declarations:D,exports:D})],t)}();t.ngf=c,t.ngfBackground=v,t.ngfDrop=d,t.ngfFormData=y,t.ngfModule=F,t.ngfSelect=g,t.ngfSrc=E,t.ngfUploadStatus=m,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=angular-file.umd.min.js.map